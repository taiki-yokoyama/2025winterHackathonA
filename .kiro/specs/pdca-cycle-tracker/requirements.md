# 要件定義書

## はじめに

本書は、CAP（Check-Action-Plan）サイクル管理システムの要件を定義します。本システムは、ユーザーが継続的改善サイクルを作成、追跡、管理することを可能にします。従来のPDCAサイクルから「Do（実行）」フェーズを除外し、結果測定（Check）、分析・改善方向の決定（Action）、次の計画（Plan）に焦点を当てることで、計画と結果に重点を置いた改善活動を支援します。

## 用語集

- **CAPシステム**: CAPサイクルを管理するソフトウェアシステム
- **CAP**: Check（結果測定）、Action（分析・改善方向）、Plan（次の計画）の3要素を含む改善サイクルの1投稿単位
- **Issue（課題）**: ユーザーが継続的に改善したい具体的なテーマ（例：体重、勉強時間、睡眠時間）
- **指標タイプ**: Issueの測定方法を示す種類（パーセンテージ、五段階尺度、数値）
- **Timeline**: ユーザーのCAP投稿履歴をissue別にタブ切り替えで時系列で表示する画面
- **コメント**: 他のユーザーがCAP投稿に対して付けるフィードバック
- **Lucideアイコン**: UIで使用するアイコンライブラリ

## データモデル参照

データベーススキーマの詳細は設計書を参照してください。主要なエンティティは以下の通りです：

- **users**: ユーザーアカウント情報
- **issues**: ユーザーが追跡する改善課題
- **caps**: Check-Action-Plan投稿レコード
- **comments**: CAP投稿に対するユーザーコメント

## 要件

### 要件1

**ユーザーストーリー:** ユーザーとして、新規アカウントを作成したい。そうすることで、システムを利用して自分の改善活動を記録できる。

#### 受入基準

1. WHEN ユーザーがサインアップフォームにメールアドレス、パスワード、名前を入力する THEN CAPシステムは、入力データを検証しなければならない
2. WHEN 入力データが有効である THEN CAPシステムは、新しいユーザーレコードをusersテーブルに作成しなければならない
3. WHEN メールアドレスが既に登録されている THEN CAPシステムは、登録を拒否し、エラーメッセージを表示しなければならない
4. WHEN ユーザー登録が成功する THEN CAPシステムは、ユーザーをログイン状態にし、Top画面にリダイレクトしなければならない

### 要件2

**ユーザーストーリー:** ユーザーとして、既存のアカウントでログインおよびログアウトしたい。そうすることで、自分のデータに安全にアクセスできる。

#### 受入基準

1. WHEN ユーザーがログインフォームにメールアドレスとパスワードを入力する THEN CAPシステムは、認証情報を検証しなければならない
2. WHEN 認証情報が正しい THEN CAPシステムは、PHPセッションを開始し、ユーザーをTop画面にリダイレクトしなければならない
3. WHEN 認証情報が間違っている THEN CAPシステムは、ログインを拒否し、エラーメッセージを表示しなければならない
4. WHEN ユーザーがログインしている THEN CAPシステムは、全ての保護されたページへのアクセスを許可しなければならない
5. WHEN ユーザーがログアウトボタンをクリックする THEN CAPシステムは、PHPセッションを破棄し、ログイン画面にリダイレクトしなければならない

### 要件3

**ユーザーストーリー:** ユーザーとして、改善したい課題を作成したい。そうすることで、その課題に対してCAP投稿を記録できる。

#### 受入基準

1. WHEN ユーザーが課題作成フォームに課題名と指標タイプを入力する THEN CAPシステムは、入力データを検証しなければならない
2. WHEN 入力データが有効である THEN CAPシステムは、新しいissueレコードをissuesテーブルに作成しなければならない
3. WHEN 課題名が空である THEN CAPシステムは、作成を拒否し、エラーメッセージをPHPセッション変数から表示しなければならない
4. WHEN 指標タイプが選択される THEN CAPシステムは、パーセンテージ、五段階尺度、数値のいずれかを保存しなければならない
5. WHEN 指標タイプが数値である THEN CAPシステムは、オプションで単位（例：「回」「cm」）を保存しなければならない
6. WHEN 課題が作成される THEN CAPシステムは、作成タイムスタンプを記録し、ユーザーをTop画面にリダイレクトしなければならない
7. WHEN 課題が作成された後 THEN CAPシステムは、その課題を読み取り専用として扱わなければならない

### 要件4

**ユーザーストーリー:** ユーザーとして、複数の課題に対して同時にCAP投稿を作成したい。そうすることで、週次の振り返りを効率的に記録できる。

#### 受入基準

1. WHEN ユーザーがCAP作成画面にアクセスする THEN CAPシステムは、ユーザーの全課題を表示しなければならない
2. WHEN ユーザーが入力を開始する THEN CAPシステムは、JavaScriptで「全課題のCheck入力→全課題のグラフ表示→全課題のAction入力→全課題のPlan入力」の順に画面遷移を制御しなければならない
3. WHEN JavaScriptが画面を制御する THEN CAPシステムは、ページリロードなしで次のステップに進み、全データをクライアント側で保持しなければならない
4. WHEN ユーザーが前の画面に戻る THEN CAPシステムは、JavaScriptで実装された戻るボタンで前のステップに遷移しなければならない
5. WHEN Check値、分析、改善方向、計画のいずれかが空である THEN CAPシステムは、送信を拒否し、PHPセッション変数からバリデーションエラーを表示しなければならない
6. WHEN ユーザーが全ての入力を完了し送信する THEN CAPシステムは、1回のPOSTリクエストで全課題のデータをサーバーに送信しなければならない
7. WHEN サーバーがデータを受信する THEN CAPシステムは、各課題に対して個別のCAPレコードをcapsテーブルに作成しなければならない
8. WHEN CAPレコードが作成される THEN CAPシステムは、user_id、issue_id、value、analysis、improve_direction、planを保存しなければならない
9. WHEN CAP投稿が成功する THEN CAPシステムは、ユーザーをTimeline画面にリダイレクトしなければならない
10. WHEN CAP投稿が作成された後 THEN CAPシステムは、そのCAP投稿を読み取り専用として扱わなければならない

### 要件5

**ユーザーストーリー:** ユーザーとして、CAP作成時に過去のデータを含むグラフを表示したい。そうすることで、推移を確認しながら分析できる。

#### 受入基準

1. WHEN ユーザーがCAP作成画面のグラフ表示ステップに進む THEN CAPシステムは、各課題の直近8週間のCAP履歴を取得しなければならない
2. WHEN 8週間分のデータが存在しない THEN CAPシステムは、存在するデータのみでグラフを生成しなければならない
3. WHEN CAP履歴が取得される THEN CAPシステムは、指標タイプに応じたグラフを生成しなければならない
4. WHEN 指標タイプがパーセンテージまたは数値である THEN CAPシステムは、折れ線グラフで時系列推移を表示しなければならない
5. WHEN 指標タイプが五段階尺度である THEN CAPシステムは、五段階尺度に適したグラフ形式で表示しなければならない
6. WHEN 新しいCheck値が入力される THEN CAPシステムは、グラフに新しいデータポイントをプレビュー表示しなければならない

### 要件6

**ユーザーストーリー:** ユーザーとして、自分や他のユーザーのTimeline画面を閲覧したい。そうすることで、CAP投稿の履歴を時系列で確認できる。

#### 受入基準

1. WHEN ユーザーがTimeline画面にアクセスする THEN CAPシステムは、対象ユーザーの全CAP投稿を時系列で表示しなければならない
2. WHEN CAP投稿が表示される THEN CAPシステムは、課題名、Check値、分析、改善方向、計画、投稿日時を表示しなければならない
3. WHEN CAP投稿にコメントが付いている THEN CAPシステムは、コメント数を表示しなければならない
4. WHEN Timeline画面が自分のものである THEN CAPシステムは、他のユーザーのTimelineと同じ形式で表示しなければならない
5. WHEN ユーザーがissueタブを切り替える THEN CAPシステムは、選択された課題のCAP投稿のみをフィルタリングして表示しなければならない
6. WHEN 1つのCAPに複数のコメントが存在する THEN CAPシステムは、全てのコメントを表示しなければならない

### 要件7

**ユーザーストーリー:** ユーザーとして、他のユーザーのCAP投稿にコメントを付けたい。そうすることで、フィードバックや励ましを送ることができる。

#### 受入基準

1. WHEN ユーザーがCAP投稿のコメント欄にテキストを入力する THEN CAPシステムは、入力を受け付けなければならない
2. WHEN ユーザーがコメントを送信する THEN CAPシステムは、commentsテーブルに新しいレコードを作成しなければならない
3. WHEN コメントレコードが作成される THEN CAPシステムは、from_user_id、to_user_id、to_cap_id、comment、作成タイムスタンプを保存しなければならない
4. WHEN コメントが投稿される THEN CAPシステムは、Timeline画面を更新してコメントを表示しなければならない
5. WHEN コメントが表示される THEN CAPシステムは、新しいコメントから順に表示しなければならない

### 要件8

**ユーザーストーリー:** ユーザーとして、Top画面で自分の課題一覧と自分宛のコメントを確認したい。そうすることで、ダッシュボードとして活用できる。

#### 受入基準

1. WHEN ユーザーがTop画面にアクセスする THEN CAPシステムは、ユーザーの全課題を目立つ位置に表示しなければならない
2. WHEN 課題が表示される THEN CAPシステムは、課題名、指標タイプ、最新のCheck値を表示しなければならない
3. WHEN ユーザー宛のコメントが存在する THEN CAPシステムは、自分宛のコメント一覧を表示しなければならない
4. WHEN コメント一覧が表示される THEN CAPシステムは、コメント送信者、コメント内容、対象CAP、投稿日時を表示しなければならない
5. WHEN Top画面にチャートが表示される THEN CAPシステムは、各課題の直近8週間の推移グラフを小さめのサマリー形式で表示しなければならない
6. WHEN 8週間分のデータが存在しない THEN CAPシステムは、存在するデータのみでグラフを生成しなければならない

### 要件9

**ユーザーストーリー:** ユーザーとして、ユーザー一覧画面から他のユーザーのTimelineにアクセスしたい。そうすることで、他のユーザーの改善活動を閲覧できる。

#### 受入基準

1. WHEN ユーザーがユーザー一覧画面にアクセスする THEN CAPシステムは、全ユーザーの一覧を表示しなければならない
2. WHEN ユーザー一覧が表示される THEN CAPシステムは、各ユーザーの名前とメールアドレスを表示しなければならない
3. WHEN ユーザーが一覧から特定のユーザーを選択する THEN CAPシステムは、そのユーザーのTimeline画面にリダイレクトしなければならない

### 要件10

**ユーザーストーリー:** ユーザーとして、視覚的に分かりやすいUIを利用したい。そうすることで、直感的にシステムを操作できる。

#### 受入基準

1. WHEN UIにアイコンが必要な場合 THEN CAPシステムは、Lucideアイコンライブラリからアイコンを使用しなければならない
2. WHEN ロゴが表示される THEN CAPシステムは、Lucideアイコンを使用してロゴを表示しなければならない

### 要件11

**ユーザーストーリー:** システム管理者として、データベースにユーザー、課題、CAP、コメントを永続化したい。そうすることで、データの整合性を保ちながら長期的に管理できる。

#### 受入基準

1. WHEN データが作成または更新される THEN CAPシステムは、MySQLデータベースに即座に永続化しなければならない
2. WHEN データベース接続エラーが発生する THEN CAPシステムは、適切なエラーコードを表示しなければならない
3. WHEN usersテーブルにレコードが作成される THEN CAPシステムは、id、email、password（平文）、name、created_atを保存しなければならない
4. WHEN issuesテーブルにレコードが作成される THEN CAPシステムは、id、user_id、name、metric_type、unit、created_atを保存しなければならない
5. WHEN capsテーブルにレコードが作成される THEN CAPシステムは、id、user_id、issue_id、value、analysis、improve_direction、plan、created_atを保存しなければならない
6. WHEN commentsテーブルにレコードが作成される THEN CAPシステムは、id、from_user_id、to_user_id、to_cap_id、comment、created_atを保存しなければならない
